#include "string.h"
#include "stdio.h"
#include "gost89.h"
#include "gosthash.h"
#include "sbox.h"
#include "util.h"
#include "dstszi.h"

static byte ZZ1[] = {
    0x05, 0x34, 0x19, 0x06, 0x74, 0xD9, 0x3B, 0x3D,
    0x23, 0x27, 0xD6, 0xB0, 0x65, 0x20, 0x7F, 0x9D,
    0xE7, 0x80, 0x63, 0x65, 0xCC
};

// ASN.1 structure
static byte SharedInfo[] = {
    0x30, 0x19,
    0x30, 0x0f, 0x06, 0x0b, 0x2a, 0x86, 0x24,
    0x02, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x03, 0x05, 0x00,
    0xA2, 0x06, 0x04, 0x04, 0x00, 0x00, 0x01, 0x00
};

static byte KEK2[] = {
    0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
    0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF
};

static byte CEK2[] = {
    0x01, 0x02, 0x03, 0x04, 0x01, 0x02, 0x03, 0x04,
    0x01, 0x02, 0x03, 0x04, 0x01, 0x02, 0x03, 0x04,
    0xF1, 0xF2, 0xF3, 0xF4, 0xF5, 0xF6, 0xF7, 0xF8,
    0xF1, 0xF2, 0xF3, 0xF4, 0xF5, 0xF6, 0xF7, 0xF8
};

static byte IV2[] = {
    0xF4, 0x77, 0xDA, 0x7A, 0xA6, 0x42, 0x4A, 0x88
};


static byte KEK1_EXPECT[] = {
    0x6b, 0xcc, 0x82, 0xb8, 0xf7, 0xa8, 0xbc, 0x9f,
    0xc8, 0xb9, 0xbd, 0x4c, 0xde, 0x18, 0xfc, 0xfe,
    0x99, 0x71, 0x17, 0x55, 0xd9, 0xac, 0x05, 0x42,
    0x2c, 0x33, 0x32, 0xf3, 0xe9, 0x6d, 0x49, 0xb8
};

int test_gost_key_wrap() {
    int err=0, ret=0;

    byte result[44], kek[KEK_SIZE];

    err = gost_kdf(ZZ1, SharedInfo, sizeof(SharedInfo), kek);
    fprintf(stderr, "kdf err: %d\n", err);
    hexdump("KEK", kek, sizeof(kek));
    if(err != 0) {
        ret = 1;
    }

    err = memcmp(KEK1_EXPECT, kek, sizeof(KEK1_EXPECT));
    fprintf(stderr, "cmp err %d\n", err);
    if(err != 0) {
        ret = 1;
    }

    err = gost_key_wrap(CEK2, KEK2, IV2, result);
    fprintf(stderr, "wrap ret %d\n", err);
    if(err != 0) {
        ret = 1;
    }

    hexdump("result", result, sizeof(result));

    fprintf(stderr, " ret : %d\n", ret);

    err = gost_key_unwrap(result, KEK2, result);
    if(err != 0) {
        ret = 1;
    }
    hexdump("unwrap", result, sizeof(CEK2));

    err = memcmp(result, CEK2, sizeof(CEK2));
    if(err != 0) {
        fprintf(stderr, "wrap-unwrap mismatch\n");
    }

    return ret;
};

int main() {
    return test_gost_key_wrap();
};
